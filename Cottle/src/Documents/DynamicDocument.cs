using System;
using System.IO;
using System.Linq;
using Cottle.Documents.Dynamic;
using Cottle.Parsers;
using Cottle.Parsers.Post;
using Cottle.Parsers.Post.Optimizers;
using Cottle.Settings;

namespace Cottle.Documents
{
	/// <summary>
	/// Dynamic document compiles template using MSIL generation for better
	/// performance. Code generated by JIT compiler can be reclaimed by garbage
	/// collector, but you should use a caching mechanism to avoid re-creating
	/// too many DynamicDocument instances using the same template source.
	/// </summary>
	public sealed class DynamicDocument : AbstractDocument
	{
		#region Attributes

		private readonly Function	main;

		#endregion

		#region Constructors

		public DynamicDocument (TextReader reader, ISetting setting)
		{
			IParser	parser;

			parser = new DefaultParser (setting.BlockBegin, setting.BlockContinue, setting.BlockEnd, setting.Escape);

			if (setting.Optimize)
			{
				parser = new PostParser (parser, new IOptimizer[]
				{
                 	new ConstantMapOptimizer (),
					new ReturnOptimizer ()
				});
			}

			this.main = new Function (new string[0], parser.Parse (reader), setting.Trimmer, string.Empty);
		}

		public DynamicDocument (TextReader reader) :
			this (reader, DefaultSetting.Instance)
		{
		}

		public DynamicDocument (string template, ISetting setting) :
			this (new StringReader (template), setting)
		{
		}

		public DynamicDocument (string template) :
			this (new StringReader (template), DefaultSetting.Instance)
		{
		}

		#endregion

		#region Methods

		public override Value Render (IStore store, TextWriter writer)
		{
			return this.main.Execute (null, store, writer);
		}

		#endregion
	}
}
